



select end_date as week_end_date,
--------------------------------------------------------------------
----- Current year values
-------------------------------------------------------------------
 sum(case when metric='Active Network Subscribers' and type='Network' then value else null end) as network_subs,
sum(case when metric='Active Viewers' and type='Network' then value else null end) as Free_Version_Active_Viewers,
sum(case when metric='Network Losses (T3 to T2)' and type='Network' then value else null end) as Network_Losses,
sum(case when metric='Hours Watched' and type='Network' then value else null end) as Total_T3_Hours,
sum(case when metric='Hours Watched Tier2' and type='Network' then value else null end) as Total_T2_Hours,
sum(case when metric='Hours per total Subscriber' and type='Network' then value else null end) as Hours_per_T3_Sub,
sum(case when metric='Hours Watched Tier2' and type='Network' then value else null end)/  
nullif(sum(case when metric='Active Network Subscribers' and type='Network' then value else null end),0) as Hours_per_T2_Sub,
 sum(case when metric='Views' and type='UGC' then value else null end) as UGC_YOUTUBE_VIEWS,
sum(case when metric='Views' and type='Owned' then value else null end) as WWE_YOUTUBE_VIEWS,
UGC_YOUTUBE_VIEWS + WWE_YOUTUBE_VIEWS as wwe_total_youtube_views,
sum(case when metric='Hours Watched' and type='UGC' then value else null end) as ugc_YOUTUBE_hours_Watched,
sum(case when metric='Hours Watched' and type='Owned' then value else null end) as WWE_YOUTUBE_hours_Watched,
ugc_YOUTUBE_hours_Watched + WWE_YOUTUBE_hours_Watched as wwe_total_youtube_hours_Watched,
sum(case when metric='Ad Impressions' and type='Owned' then value else null end) as WWE_YOUTUBE_IMPRESSIONS,
sum(case when metric='Ad Impressions' and type='UGC' then value else null end) as UGC_YOUTUBE_IMPRESSIONS,
sum(case when metric='Views' and type='Twitter' then value else null end) as twitter_views,
sum(case when metric='Hours Watched' and type='Twitter' then value else null end) as twitter_hours_Watched ,
sum(case when metric='Views' and type='Instagram' then value else null end) as instagram_views,
sum(case when metric='Hours Watched' and type='Instagram' then value else null end) as instagram_hours_Watched,
sum(case when metric='Views' and type='Snapchat' then value else null end) as Snapchat_views,
sum(case when metric='Hours Watched' and type='Snapchat' then value else null end) as Snapchat_hours_Watched ,
 sum(case when metric='Views' and type='Dotcom' then value else null end) as Dotcom_views,
sum(case when metric='Hours Watched' and type='Dotcom' then value else null end) as Dotcom_hours_Watched ,
 sum(case when metric='Views' and type='Facebook' then value else null end) as facebook_views,
sum(case when metric='Hours Watched' and type='Facebook' then value else null end) as facebook_hours_Watched ,
 sum(case when metric='Views' and type='TikTok' then value else null end) as tiktok_views,
sum(case when metric='Hours Watched' and type='TikTok' then value else null end) as tiktok_hours_Watched ,
twitter_views+instagram_views+Snapchat_views+Dotcom_views+facebook_views+tiktok_views as views_except_yt,
twitter_hours_Watched+instagram_hours_Watched+Snapchat_hours_Watched+Dotcom_hours_Watched+facebook_hours_Watched+tiktok_hours_Watched as hours_watched_except_yt,
 sum(case when metric='Coverage HH rating' and type='NXT' then value else null end) as NXT_COVERAGE_RATING ,
sum(case when metric='Coverage HH rating' and type='RAW' then value else null end) as RAW_COVERAGE_RATING,
sum(case when metric='Coverage HH rating' and type='SMD' then value else null end) as SMD_COVERAGE_RATING,
sum(case when metric='National HH Rating' and type='NXT' then value else null end) as NXT_NATIONAL_RATING ,
sum(case when metric='National HH Rating' and type='RAW' then value else null end) as RAW_NATIONAL_RATING,
sum(case when metric='National HH Rating' and type='SMD' then value else null end) as SMD_NATIONAL_RATING,
sum(case when metric='RAW-Avg Viewers' and type='Female' then value else null end) as raw_average_viewers_female,
sum(case when metric='RAW-Avg Viewers' and type='Male' then value else null end) as raw_average_viewers_male,
sum(case when metric='RAW-Avg Viewers' and type='Total' then value else null end) as raw_average_viewers_total,
sum(case when metric='SMD-Avg Viewers' and type='Female' then value else null end) as smd_average_viewers_female,
sum(case when metric='SMD-Avg Viewers' and type='Male' then value else null end) as smd_average_viewers_male,
sum(case when metric='SMD-Avg Viewers' and type='Total' then value else null end) as smd_average_viewers_total ,
sum(case when metric='RAW-Avg Viewers' and type='Ages 55+' then value else null end) as raw_average_viewers_age_55_plus,
sum(case when metric='RAW-Avg Viewers' and type='Ages 35-54' then value else null end) as raw_average_viewers_age_35_54,
sum(case when metric='RAW-Avg Viewers' and type='Ages 2-17' then value else null end) as raw_average_viewers_age_2_17,
sum(case when metric='RAW-Avg Viewers' and type='Ages 18-49' then value else null end) as raw_average_viewers_age_18_49,
sum(case when metric='RAW-Avg Viewers' and type='Ages 18-34' then value else null end) as raw_average_viewers_age_18_34,
 sum(case when metric='SMD-Avg Viewers' and type='Ages 55+' then value else null end) as smd_average_viewers_age_55_plus,
sum(case when metric='SMD-Avg Viewers' and type='Ages 35-54' then value else null end) as smd_average_viewers_age_35_54,
sum(case when metric='SMD-Avg Viewers' and type='Ages 2-17' then value else null end) as smd_average_viewers_age_2_17,
sum(case when metric='SMD-Avg Viewers' and type='Ages 18-49' then value else null end) as smd_average_viewers_age_18_49,
sum(case when metric='SMD-Avg Viewers' and type='Ages 18-34' then value else null end) as smd_average_viewers_age_18_34,
sum(case when metric='Total Paid Attendance' and type='Live Events' then value else null end) as total_paid_attendance,
sum(case when metric='Average Total Attendance' and type='Live Events' then value else null end) as average_total_attendance,
sum(case when metric='Average House Event Attendance' and type='Live Events' then value else null end) as average_house_event_attendance,
sum(case when metric='Average Raw House Event Attendance' and type='Live Events' then value else null end) as average_raw_house_event_attendance,
sum(case when metric='Average Raw TV Event Attendance' and type='Live Events' then value else null end) as average_raw_tv_event_attendance,
----------------------------------------------------
-------previous year values
----------------------------------------------------
sum(case when metric='Active Network Subscribers' and type='Network' then prev_year_value else null end) as network_subs_ly,
sum(case when metric='Active Viewers' and type='Network' then prev_year_value else null end) as Free_Version_Active_Viewers_ly,
sum(case when metric='Network Losses (T3 to T2)' and type='Network' then prev_year_value else null end) as Network_Losses_ly,
sum(case when metric='Hours Watched' and type='Network' then prev_year_value else null end) as Total_T3_Hours_ly,
sum(case when metric='Hours Watched Tier2' and type='Network' then prev_year_value else null end) as Total_T2_Hours_ly,
sum(case when metric='Hours per total Subscriber' and type='Network' then prev_year_value else null end) as Hours_per_T3_Sub_ly,
sum(case when metric='Hours Watched Tier2' and type='Network' then prev_year_value else null end)/  
nullif(sum(case when metric='Active Network Subscribers' and type='Network' then prev_year_value else null end),0) as Hours_per_T2_Sub_ly,
 sum(case when metric='Views' and type='UGC' then prev_year_value else null end) as UGC_YOUTUBE_VIEWS_ly,
sum(case when metric='Views' and type='Owned' then prev_year_value else null end) as WWE_YOUTUBE_VIEWS_ly,
UGC_YOUTUBE_VIEWS_ly + WWE_YOUTUBE_VIEWS_ly as wwe_total_youtube_views_ly,
sum(case when metric='Hours Watched' and type='UGC' then prev_year_value else null end) as ugc_YOUTUBE_hours_Watched_ly,
sum(case when metric='Hours Watched' and type='Owned' then prev_year_value else null end) as WWE_YOUTUBE_hours_Watched_ly,
ugc_YOUTUBE_hours_Watched_ly + WWE_YOUTUBE_hours_Watched_ly as wwe_total_youtube_hours_Watched_ly,
sum(case when metric='Ad Impressions' and type='Owned' then prev_year_value else null end) as WWE_YOUTUBE_IMPRESSIONS_ly,
sum(case when metric='Ad Impressions' and type='UGC' then prev_year_value else null end) as UGC_YOUTUBE_IMPRESSIONS_ly,
sum(case when metric='Views' and type='Twitter' then prev_year_value else null end) as twitter_views_ly,
sum(case when metric='Hours Watched' and type='Twitter' then prev_year_value else null end) as twitter_hours_Watched_ly ,
sum(case when metric='Views' and type='Instagram' then prev_year_value else null end) as instagram_views_ly,
sum(case when metric='Hours Watched' and type='Instagram' then prev_year_value else null end) as instagram_hours_Watched_ly,
sum(case when metric='Views' and type='Snapchat' then prev_year_value else null end) as Snapchat_views_ly,
sum(case when metric='Hours Watched' and type='Snapchat' then prev_year_value else null end) as Snapchat_hours_Watched_ly ,
 sum(case when metric='Views' and type='Dotcom' then prev_year_value else null end) as Dotcom_views_ly,
sum(case when metric='Hours Watched' and type='Dotcom' then prev_year_value else null end) as Dotcom_hours_Watched_ly ,
 sum(case when metric='Views' and type='Facebook' then prev_year_value else null end) as facebook_views_ly,
sum(case when metric='Hours Watched' and type='Facebook' then prev_year_value else null end) as facebook_hours_Watched_ly ,
 sum(case when metric='Views' and type='TikTok' then prev_year_value else null end) as tiktok_views_ly,
sum(case when metric='Hours Watched' and type='TikTok' then prev_year_value else null end) as tiktok_hours_Watched_ly ,
twitter_views_ly+instagram_views_ly+Snapchat_views_ly+Dotcom_views_ly+facebook_views_ly+tiktok_views_ly as views_except_yt_ly,
twitter_hours_Watched_ly+instagram_hours_Watched_ly+Snapchat_hours_Watched_ly+Dotcom_hours_Watched_ly+facebook_hours_Watched_ly+tiktok_hours_Watched_ly as hours_watched_except_yt_ly,
 sum(case when metric='Coverage HH rating' and type='NXT' then prev_year_value else null end) as NXT_COVERAGE_RATING_LY ,
sum(case when metric='Coverage HH rating' and type='RAW' then prev_year_value else null end) as RAW_COVERAGE_RATING_LY,
sum(case when metric='Coverage HH rating' and type='SMD' then prev_year_value else null end) as SMD_COVERAGE_RATING_LY,
sum(case when metric='National HH Rating' and type='NXT' then prev_year_value else null end) as NXT_NATIONAL_RATING_LY,
sum(case when metric='National HH Rating' and type='RAW' then prev_year_value else null end) as RAW_NATIONAL_RATING_LY,
sum(case when metric='National HH Rating' and type='SMD' then prev_year_value else null end) as SMD_NATIONAL_RATING_LY,
sum(case when metric='RAW-Avg Viewers' and type='Female' then prev_year_value else null end) as raw_average_viewers_female_ly,
sum(case when metric='RAW-Avg Viewers' and type='Male' then prev_year_value else null end) as raw_average_viewers_male_ly,
sum(case when metric='RAW-Avg Viewers' and type='Total' then prev_year_value else null end) as raw_average_viewers_total_ly,
sum(case when metric='SMD-Avg Viewers' and type='Female' then prev_year_value else null end) as smd_average_viewers_female_ly,
sum(case when metric='SMD-Avg Viewers' and type='Male' then prev_year_value else null end) as smd_average_viewers_male_ly,
sum(case when metric='SMD-Avg Viewers' and type='Total' then prev_year_value else null end) as smd_average_viewers_total_ly ,
sum(case when metric='RAW-Avg Viewers' and type='Ages 55+' then prev_year_value else null end) as raw_average_viewers_age_55_plus_ly,
sum(case when metric='RAW-Avg Viewers' and type='Ages 35-54' then prev_year_value else null end) as raw_average_viewers_age_35_54_ly,
sum(case when metric='RAW-Avg Viewers' and type='Ages 2-17' then prev_year_value else null end) as raw_average_viewers_age_2_17_ly,
sum(case when metric='RAW-Avg Viewers' and type='Ages 18-49' then prev_year_value else null end) as raw_average_viewers_age_18_49_ly,
sum(case when metric='RAW-Avg Viewers' and type='Ages 18-34' then prev_year_value else null end) as raw_average_viewers_age_18_34_ly,
 sum(case when metric='SMD-Avg Viewers' and type='Ages 55+' then prev_year_value else null end) as smd_average_viewers_age_55_plus_ly,
sum(case when metric='SMD-Avg Viewers' and type='Ages 35-54' then prev_year_value else null end) as smd_average_viewers_age_35_54_ly,
sum(case when metric='SMD-Avg Viewers' and type='Ages 2-17' then prev_year_value else null end) as smd_average_viewers_age_2_17_ly,
sum(case when metric='SMD-Avg Viewers' and type='Ages 18-49' then prev_year_value else null end) as smd_average_viewers_age_18_49_ly,
sum(case when metric='SMD-Avg Viewers' and type='Ages 18-34' then prev_year_value else null end) as smd_average_viewers_age_18_34_ly,
sum(case when metric='Total Paid Attendance' and type='Live Events' then prev_year_value else null end) as total_paid_attendance_ly,
sum(case when metric='Average Total Attendance' and type='Live Events' then prev_year_value else null end) as average_total_attendance_ly,
sum(case when metric='Average House Event Attendance' and type='Live Events' then prev_year_value else null end) as average_house_event_attendance_ly,
sum(case when metric='Average Raw House Event Attendance' and type='Live Events' then prev_year_value else null end) as average_raw_house_event_attendance_ly,
sum(case when metric='Average Raw TV Event Attendance' and type='Live Events' then prev_year_value else null end) as average_raw_tv_event_attendance_ly
from "entdwdb"."fds_cp"."vw_rpt_cp_weekly_consolidated_kpi" where granularity='Weekly' and week_end_Date>= dateadd(week,-52,current_Date)
group by 1